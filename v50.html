<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sector Radar | Find Your Edge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0/dist/chartjs-chart-treemap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome CDN for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Custom styles for the page */
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-text {
            background: linear-gradient(to right, #10B981, #3B82F6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* Visual cue for heatmap filter */
        .flash-border {
            transition: box-shadow 0.2s ease-in-out;
            box-shadow: 0 0 0 3px #10B981; /* emerald-500 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">

    <!-- HERO SECTION -->
    <header class="pt-16 pb-20 md:pt-20 md:pb-28 text-center">
        <div class="container mx-auto px-6">
            <h1 class="text-4xl md:text-6xl font-bold text-white leading-tight mb-4">
                Find Your <span class="gradient-text">Edge</span>
            </h1>
            <p class="max-w-3xl mx-auto text-lg md:text-xl text-gray-400 leading-relaxed">
                Track momentum. Follow the capital. Decode the market. Make your move.
            </p>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <section class="relative z-10 -mt-12 md:-mt-20 pb-12 md:pb-16">
        <main class="container mx-auto px-4 sm:px-6">

            <div class="mb-8 border-b border-gray-700 pb-3">
                 <h2 class="text-2xl sm:text-3xl font-bold text-white">
                    Daily Sector Performance
                </h2>
            </div>

            <!-- Treemap Section -->
            <div id="treemap-skeleton" class="animate-pulse w-full h-[50vh] bg-gray-800/50 rounded-lg"></div>
            <div id="treemap-container" class="hidden grid-cols-1 lg:grid-cols-3 gap-8 items-stretch">
                <div class="lg:col-span-3 flex flex-col justify-center items-center relative">
                    <div class="relative w-full h-full min-h-[50vh]">
                        <canvas id="treemap-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- AI Insights Section -->
            <section id="commentary" class="mt-12">
                <h2 class="text-2xl sm:text-3xl font-bold text-white mb-6 border-b border-gray-700 pb-3">
                    AI-Powered Insights
                </h2>
                <div id="commentary-content" class="space-y-8">
                    </div>
            </section>

            <!-- Heatmap Section -->
            <section id="history" class="mt-12">
                <div id="heatmap-skeleton" class="animate-pulse">
                     <div class="h-10 bg-gray-700/60 rounded-md mb-6"></div>
                     <div class="h-[500px] bg-gray-800/50 rounded-lg"></div>
                </div>

                <div id="heatmap-content" class="hidden">
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 border-b border-gray-700 pb-3">
                         <h2 class="text-2xl sm:text-3xl font-bold text-white mb-4 md:mb-0">
                            Historical Performance (Year-to-Date)
                        </h2>
                        <div class="relative inline-block text-left">
                            <div>
                                <button type="button" class="inline-flex justify-center w-full rounded-md border border-gray-700 shadow-sm px-4 py-2 bg-gray-800 text-sm font-medium text-gray-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-emerald-500" id="filter-button" aria-haspopup="true" aria-expanded="false">
                                    Filter Sectors
                                    <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                            <div id="filter-dropdown" class="origin-top-left md:origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-gray-800 ring-1 ring-black ring-opacity-5 focus:outline-none z-50 transition-all ease-out duration-200 transform opacity-0 scale-95 invisible" role="menu" aria-orientation="vertical" aria-labelledby="filter-button">
                                <div id="filter-checkboxes" class="py-1" role="none">
                                    </div>
                            </div>
                        </div>
                    </div>

                    <div class="relative border border-transparent rounded-lg" id="heatmap-container">
                        <div id="heatmap-chart" style="width: 100%; height: 500px;"></div>
                        <div id="heatmap-labels-container"></div>
                    </div>
                </div>
                <div class="text-center mt-4">
                    <button id="exportCsvBtn" disabled class="inline-flex items-center gap-2 bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors cursor-not-allowed opacity-50">
                        <i class="fas fa-download mr-2"></i>
                        <span>Export Chart Data as CSV</span>
                    </button>
                </div>
            </section>

            <!-- Data Timestamp -->
            <div id="data-info-container" class="mt-6 text-center md:text-right">
                <p id="data-timestamp" class="text-xs text-gray-500"></p>
            </div>
        </main>
    </section>

    <!-- FOOTER from index.html -->
    <footer class="bg-gray-800 border-t border-gray-700">
        <div class="container mx-auto px-6 py-8 text-center text-gray-400">
            <a href="https://KaChing-Labs.com" class="text-base md:text-lg font-semibold text-white">KaChing <span class="text-emerald-400">Labs</span></a>
            <p class="mt-2 text-sm">Intelligent tools for your financial journey.</p>
            <p class="mt-4 text-xs">
                &copy; 2025 KaChing Labs. All Rights Reserved.
                <span class="mx-2 text-gray-600">|</span>
                <a href="https://kaching-labs.com/legal.html" class="hover:text-emerald-400 underline">Legal Information</a>
            </p>
        </div>
    </footer>

    <script>
        let heatmapChart = null;
        let heatmapDataForExport = [];
        let staticHeatmapData = []; // Store the generated heatmap data here

        // Centralized color configuration object for all charts, aligned with brand guidelines
        const colorConfig = {
            treemap: {
                strongPositive: (opacity = 0.8) => `rgba(16, 185, 129, ${opacity})`,
                lightPositive: (opacity = 0.8) => `rgba(52, 211, 153, ${opacity})`,
                strongNegative: (opacity = 0.8) => `rgba(239, 68, 68, ${opacity})`,
                lightNegative: (opacity = 0.8) => `rgba(248, 113, 113, ${opacity})`,
                neutral: (opacity = 0.8) => `rgba(107, 114, 128, ${opacity})`,
                border: '#1F2937', // bg-gray-800
                tooltip: {
                    background: '#1F2937',
                    title: '#FFFFFF',
                    body: '#D1D5DB',
                    border: '#374151'
                }
            },
            heatmap: {
                strongPositive: '#10B981',
                lightPositive: '#34D399',
                strongNegative: '#EF4444',
                lightNegative: '#F87171',
                neutral: '#D1D5DB',
                empty: '#374151',
                border: '#111827',
                splitArea: ['rgba(17, 24, 39, 0)', 'rgba(31, 41, 55, 0.6)']
            },
            indicatorChart: {
                line: '#34D399', // emerald-400
                axisLabel: '#9CA3AF', // gray-400
                splitLine: 'rgba(75, 85, 99, 0.4)' // gray-600 with opacity
            }
        };

        // --- Placeholder Data Generation ---
        function generateIndicatorData(days = 90) {
            const data = [];
            let value = 50 + (Math.random() - 0.5) * 10;
            const now = new Date();
            for (let i = days; i > 0; i--) {
                const date = new Date(now);
                date.setDate(now.getDate() - i);
                value += (Math.random() - 0.5) * 2;
                if (value > 90) value = 90;
                if (value < 10) value = 10;
                data.push([date.getTime(), value]);
            }
            return data;
        }

        const marketData = {
            "lastUpdated": "2025-07-17T16:00:00Z",
            "overall_commentary": "The market saw mixed performance today, with significant divergence between growth-oriented sectors like Technology and Energy, and defensive or interest-rate-sensitive sectors like Utilities and Real Estate. This suggests a rotational environment where investors are actively reallocating capital based on shifting economic outlooks and commodity prices.",
            "overallMarketTechnicals": {
                "rsi": generateIndicatorData(),
                "mfi": generateIndicatorData(),
                "obv": generateIndicatorData().map(([time, val]) => [time, val * 100000])
            },
            "sectors": [
                { "sector": "Information Technology", "market_weight": 0.28, "change_pct": 1.25, "insights": "The tech sector's gain of 1.25% reflects ongoing investor confidence...", "technicalIndicators": { "rsi": generateIndicatorData(), "mfi": generateIndicatorData(), "obv": generateIndicatorData().map(([time, val]) => [time, val * 100000]) } },
                { "sector": "Health Care", "market_weight": 0.14, "change_pct": 0.40, "insights": "Health Care saw steady gains...", "technicalIndicators": { "rsi": generateIndicatorData(), "mfi": generateIndicatorData(), "obv": generateIndicatorData().map(([time, val]) => [time, val * 100000]) } },
                { "sector": "Financials", "market_weight": 0.12, "change_pct": -0.20, "insights": "Financials experienced a minor dip...", "technicalIndicators": { "rsi": generateIndicatorData(), "mfi": generateIndicatorData(), "obv": generateIndicatorData().map(([time, val]) => [time, val * 100000]) } },
                { "sector": "Consumer Discretionary", "market_weight": 0.10, "change_pct": -1.75, "insights": "This sector's sharp decline suggests worries about consumer spending power...", "technicalIndicators": { "rsi": generateIndicatorData(), "mfi": generateIndicatorData(), "obv": generateIndicatorData().map(([time, val]) => [time, val * 100000]) } },
                { "sector": "Communication Services", "market_weight": 0.09, "change_pct": 0.95, "insights": "A solid gain for Communication Services was driven by strong performance...", "technicalIndicators": { "rsi": generateIndicatorData(), "mfi": generateIndicatorData(), "obv": generateIndicatorData().map(([time, val]) => [time, val * 100000]) } },
                { "sector": "Industrials", "market_weight": 0.08, "change_pct": 0.15, "insights": "The Industrials sector saw a slight uptick...", "technicalIndicators": { "rsi": generateIndicatorData(), "mfi": generateIndicatorData(), "obv": generateIndicatorData().map(([time, val]) => [time, val * 100000]) } },
                { "sector": "Consumer Staples", "market_weight": 0.06, "change_pct": -0.50, "insights": "A slight loss for this defensive sector...", "technicalIndicators": { "rsi": generateIndicatorData(), "mfi": generateIndicatorData(), "obv": generateIndicatorData().map(([time, val]) => [time, val * 100000]) } },
                { "sector": "Energy", "market_weight": 0.05, "change_pct": 2.10, "insights": "The Energy sector led the market with a strong 2.10% gain...", "technicalIndicators": { "rsi": generateIndicatorData(), "mfi": generateIndicatorData(), "obv": generateIndicatorData().map(([time, val]) => [time, val * 100000]) } },
                { "sector": "Utilities", "market_weight": 0.03, "change_pct": -0.90, "insights": "Utilities, a typically stable sector, saw a notable decline...", "technicalIndicators": { "rsi": generateIndicatorData(), "mfi": generateIndicatorData(), "obv": generateIndicatorData().map(([time, val]) => [time, val * 100000]) } },
                { "sector": "Real Estate", "market_weight": 0.03, "change_pct": -1.10, "insights": "The decline in Real Estate is likely a direct response to fears of rising interest rates...", "technicalIndicators": { "rsi": generateIndicatorData(), "mfi": generateIndicatorData(), "obv": generateIndicatorData().map(([time, val]) => [time, val * 100000]) } },
                { "sector": "Materials", "market_weight": 0.02, "change_pct": 0.05, "insights": "The Materials sector was nearly unchanged...", "technicalIndicators": { "rsi": generateIndicatorData(), "mfi": generateIndicatorData(), "obv": generateIndicatorData().map(([time, val]) => [time, val * 100000]) } }
            ]
        };

        // --- Chart Generation ---

        function generateIndicatorChart(containerId, title, data) {
            const chartDom = document.getElementById(containerId);
            if (!chartDom) return;
            const myChart = echarts.init(chartDom);
            const option = {
                title: {
                    text: title,
                    left: 'center',
                    textStyle: { color: '#D1D5DB', fontSize: 14, fontWeight: 'normal' }
                },
                grid: { top: '20%', bottom: '15%', left: '18%', right: '5%' },
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        const date = new Date(params[0].axisValue).toLocaleDateString();
                        const value = params[0].value[1].toFixed(2);
                        return `${date}<br/>${title}: ${value}`;
                    }
                },
                xAxis: {
                    type: 'time',
                    axisLabel: { color: colorConfig.indicatorChart.axisLabel, fontSize: 10 },
                    splitLine: { show: false }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { color: colorConfig.indicatorChart.axisLabel, fontSize: 10,
                        formatter: function (value) {
                           if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                           if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
                           return value;
                        }
                    },
                    splitLine: { lineStyle: { color: colorConfig.indicatorChart.splitLine, type: 'dashed' } }
                },
                series: [{
                    data: data,
                    type: 'line',
                    smooth: true,
                    showSymbol: false,
                    lineStyle: { color: colorConfig.indicatorChart.line, width: 2 }
                }]
            };
            myChart.setOption(option);
        }

        function generateCommentary(data) {
            const container = document.getElementById('commentary-content');

            const overallMarketId = 'Overall-Market';
            let html = `<div class="bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-xl font-bold text-white mb-2">Overall Market</h3>
                    <p class="text-gray-400 leading-relaxed">${data.overall_commentary}</p>
                    <div class="mt-4 pt-4 border-t border-gray-700 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div id="rsi-chart-${overallMarketId}" style="width: 100%; height: 150px;"></div>
                        <div id="mfi-chart-${overallMarketId}" style="width: 100%; height: 150px;"></div>
                        <div id="obv-chart-${overallMarketId}" style="width: 100%; height: 150px;"></div>
                    </div>
                </div>`;

            data.sectors.forEach(sector => {
                const sectorId = sector.sector.replace(/\s+/g, '-');
                const isPositive = sector.change_pct >= 0;
                const colorClass = isPositive ? 'text-emerald-400' : 'text-red-400';
                const sign = isPositive ? '+' : '';
                const formattedChange = `${sign}${sector.change_pct.toFixed(2)}%`;
                html += `<div class="bg-gray-800 p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-xl font-bold text-white">${sector.sector}</h3>
                            <span class="text-xl font-semibold ${colorClass}">${formattedChange}</span>
                        </div>
                        <p class="text-gray-400 leading-relaxed">${sector.insights}</p>
                        <div class="mt-4 pt-4 border-t border-gray-700 grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div id="rsi-chart-${sectorId}" style="width: 100%; height: 150px;"></div>
                            <div id="mfi-chart-${sectorId}" style="width: 100%; height: 150px;"></div>
                            <div id="obv-chart-${sectorId}" style="width: 100%; height: 150px;"></div>
                        </div>
                    </div>`;
            });
            container.innerHTML = html;

            setTimeout(() => {
                 generateIndicatorChart(`rsi-chart-${overallMarketId}`, 'RSI', data.overallMarketTechnicals.rsi);
                 generateIndicatorChart(`mfi-chart-${overallMarketId}`, 'MFI', data.overallMarketTechnicals.mfi);
                 generateIndicatorChart(`obv-chart-${overallMarketId}`, 'OBV', data.overallMarketTechnicals.obv);

                data.sectors.forEach(sector => {
                    const sectorId = sector.sector.replace(/\s+/g, '-');
                    generateIndicatorChart(`rsi-chart-${sectorId}`, 'RSI', sector.technicalIndicators.rsi);
                    generateIndicatorChart(`mfi-chart-${sectorId}`, 'MFI', sector.technicalIndicators.mfi);
                    generateIndicatorChart(`obv-chart-${sectorId}`, 'OBV', sector.technicalIndicators.obv);
                });
            }, 50);
        }

        function generateStaticHeatmapData() {
            const weeks = Array.from({ length: 52 }, (_, i) => i);
            const allSectors = marketData.sectors.map(s => s.sector);
            const EMPTY_VALUE = -999;
            const currentWeek = 5;
            const data = [];
            for (let i = 0; i < weeks.length; i++) {
                for (let j = 0; j < allSectors.length; j++) {
                    if (i < currentWeek) {
                        const performance = (Math.random() * 8 - 4);
                        data.push([i, j, performance]);
                    } else {
                        data.push([i, j, EMPTY_VALUE]);
                    }
                }
            }
            staticHeatmapData = data;
        }
        function generatePage() {
            try {
                const sectorData = marketData.sectors;
                generateStaticHeatmapData();
                if (marketData.lastUpdated) {
                    const date = new Date(marketData.lastUpdated);
                    const formattedDate = `Data last modified: ${date.toLocaleString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: '2-digit', timeZoneName: 'short' })}`;
                    document.getElementById('data-timestamp').textContent = formattedDate;
                }
                setTimeout(() => {
                    document.getElementById('treemap-skeleton').classList.add('hidden');
                    document.getElementById('treemap-container').classList.remove('hidden');
                    generateTreemap(sectorData);
                }, 500);
                generateCommentary(marketData);
                generateFilterControls(sectorData);
                setTimeout(() => {
                    document.getElementById('heatmap-skeleton').classList.add('hidden');
                    document.getElementById('heatmap-content').classList.remove('hidden');
                    generateHeatmap(sectorData);
                    const exportBtn = document.getElementById('exportCsvBtn');
                    exportBtn.disabled = false;
                    exportBtn.classList.remove('bg-gray-600', 'cursor-not-allowed', 'opacity-50');
                    exportBtn.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
                }, 500);
                renderHeatmapLabels();
            } catch (error) {
                console.error("Failed to generate page:", error);
                document.body.innerHTML = `<div class="flex items-center justify-center h-screen text-red-400 p-4 text-center"><p>Error: Could not load page content. Please check the console.</p></div>`;
            }
        }
        function generateTreemap(data) {
            const ctx = document.getElementById('treemap-chart').getContext('2d');
            const treemapData = data.map(sector => ({ ...sector, value: sector.market_weight }));
            new Chart(ctx, {
                type: 'treemap',
                data: {
                    datasets: [{
                        label: 'S&P 500 Sectors',
                        data: treemapData,
                        backgroundColor: (context) => {
                            if (context.type !== 'data') return 'transparent';
                            const sectorData = treemapData[context.dataIndex];
                            if (!sectorData) return colorConfig.treemap.neutral();
                            const change = sectorData.change_pct;
                            if (change > 1.0) return colorConfig.treemap.strongPositive();
                            if (change > 0) return colorConfig.treemap.lightPositive();
                            if (change < -1.0) return colorConfig.treemap.strongNegative();
                            if (change < 0) return colorConfig.treemap.lightNegative();
                            return colorConfig.treemap.neutral();
                        },
                        borderColor: colorConfig.treemap.border,
                        borderWidth: 0,
                        spacing: 1,
                        key: 'value',
                        labels: {
                            display: true,
                            color: 'white',
                            align: 'center',
                            position: 'middle',
                            font: function(context) {
                                if (context.type !== 'data') return {};
                                const chartWidth = context.chart.width;
                                const baseSize = 8 + (chartWidth / 100);
                                const sectorData = treemapData[context.dataIndex];
                                let finalSize = baseSize;
                                let lh = 1.2;
                                if (sectorData) {
                                    const weight = sectorData.market_weight;
                                    if (weight < 0.05) {
                                        finalSize *= 0.75;
                                        lh = 1.1;
                                    } else if (weight < 0.10) {
                                        finalSize *= 0.9;
                                    }
                                }
                                return { family: 'Inter, sans-serif', size: Math.round(Math.max(7, finalSize)), weight: '500', lineHeight: lh };
                            },
                            formatter: (context) => {
                                if (context.type !== 'data') return null;
                                const sectorData = treemapData[context.dataIndex];
                                if (!sectorData || !sectorData.sector) return null;
                                const text = sectorData.sector;
                                const words = text.split(' ');
                                const weight = sectorData.market_weight;
                                const isMobile = window.innerWidth <= 768;
                                if (isMobile && weight <= 0.025) {
                                    if (words.length === 1 && text.length > 8) {
                                        const mid = Math.round(text.length / 2);
                                        return [text.slice(0, mid), text.slice(mid)];
                                    }
                                    return words;
                                } else {
                                    return words;
                                }
                            }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: colorConfig.treemap.tooltip.background,
                            titleColor: colorConfig.treemap.tooltip.title,
                            bodyColor: colorConfig.treemap.tooltip.body,
                            borderColor: colorConfig.treemap.tooltip.border,
                            borderWidth: 1,
                            padding: 10,
                            callbacks: {
                                title: (items) => items.length > 0 ? treemapData[items[0].dataIndex].sector : null,
                                label: (context) => {
                                    const data = treemapData[context.dataIndex];
                                    if (!data) return null;
                                    const weight = (data.market_weight * 100).toFixed(2);
                                    const change = data.change_pct.toFixed(2);
                                    const sign = data.change_pct >= 0 ? '+' : '';
                                    return [`Market Weight: ${weight}%`, `Change: ${sign}${change}%`];
                                }
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 0,
                            bottom: 0,
                            left: 0,
                            right: 0
                        }
                    }
                }
            });
        }
        function generateFilterControls(allSectors) {
            const button = document.getElementById('filter-button');
            const dropdown = document.getElementById('filter-dropdown');
            const checkboxContainer = document.getElementById('filter-checkboxes');
            let checkboxHTML = '';
            allSectors.forEach(sector => {
                checkboxHTML += `
                    <label class="flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 cursor-pointer">
                        <input type="checkbox" name="sector-filter" value="${sector.sector}" checked class="h-4 w-4 bg-gray-900 border-gray-600 text-emerald-600 rounded focus:ring-emerald-500">
                        <span class="ml-3">${sector.sector}</span>
                    </label>`;
            });
            checkboxContainer.innerHTML = checkboxHTML;
            button.addEventListener('click', () => {
                const isHidden = dropdown.classList.contains('invisible');
                dropdown.classList.toggle('invisible');
                dropdown.classList.toggle('opacity-0');
                dropdown.classList.toggle('scale-95');
                button.setAttribute('aria-expanded', isHidden.toString());
            });
            document.addEventListener('click', (event) => {
                if (!button.contains(event.target) && !dropdown.contains(event.target)) {
                    dropdown.classList.add('invisible', 'opacity-0', 'scale-95');
                    button.setAttribute('aria-expanded', 'false');
                }
            });
            checkboxContainer.addEventListener('change', () => {
                const selectedSectors = Array.from(checkboxContainer.querySelectorAll('input[type="checkbox"]:checked'))
                                             .map(cb => cb.value);
                const filteredData = marketData.sectors.filter(sector => selectedSectors.includes(sector.sector));
                generateHeatmap(filteredData);
                const heatmapContainer = document.getElementById('heatmap-container');
                heatmapContainer.classList.add('flash-border');
                setTimeout(() => {
                    heatmapContainer.classList.remove('flash-border');
                }, 500);
            });
        }
        function renderHeatmapLabels() {
            const container = document.getElementById('heatmap-labels-container');
            container.innerHTML = '';
        }
        function getHeatmapOption(sectorData) {
            const isMobile = window.innerWidth < 768;
            const weeks = Array.from({ length: 52 }, (_, i) => `${i + 1}`);
            const sectors = sectorData.map(s => s.sector).reverse();
            const allSectors = marketData.sectors.map(s => s.sector);
            const data = staticHeatmapData.filter(([weekIndex, sectorIndex, value]) => {
                const sectorName = allSectors[sectorIndex];
                return sectorData.some(s => s.sector === sectorName);
            }).map(([weekIndex, sectorIndex, value]) => {
                const originalSectorName = allSectors[sectorIndex];
                const newSectorIndex = sectors.indexOf(originalSectorName);
                return [weekIndex, newSectorIndex, value];
            });
            heatmapDataForExport = { sectors, weeks, data };
            return {
                tooltip: {
                    position: 'top',
                    formatter: function (params) {
                        const EMPTY_VALUE = -999;
                        if (params.value[2] === EMPTY_VALUE) return;
                        if (sectors.length === 0) return '';
                        const week = weeks[params.data[0]];
                        const sector = sectors[params.data[1]];
                        const perf = params.data[2];
                        const sign = perf >= 0 ? '+' : '';
                        return `Week ${week}: ${sector}<br/>Perf: ${sign}${perf.toFixed(2)}%`;
                    }
                },
                grid: {
                    left: '15%',
                    right: '4%',
                    top: '10',
                    bottom: 60
                },
                xAxis: {
                    type: 'category',
                    data: weeks,
                    splitArea: { show: true, areaStyle: { color: colorConfig.heatmap.splitArea } },
                    axisLine: { show: false },
                    axisTick: { show: false },
                    axisLabel: {
                        show: !isMobile,
                    }
                },
                yAxis: {
                    type: 'category',
                    data: sectors,
                    splitArea: { show: true, areaStyle: { color: colorConfig.heatmap.splitArea } },
                    axisLine: { show: false },
                    axisTick: { show: false },
                    axisLabel: {
                        fontSize: isMobile ? 10 : 12,
                        formatter: function (value) {
                            if (isMobile) {
                                const parts = value.split(' ');
                                if (parts.length > 1) {
                                    return parts.join('\n');
                                }
                            }
                            return value;
                        }
                    }
                },
                series: [{
                    name: 'Weekly Performance',
                    type: 'heatmap',
                    data: data,
                    label: { show: false },
                    itemStyle: {
                        color: (params) => {
                            const EMPTY_VALUE = -999;
                            const value = params.value[2];
                            if (value === EMPTY_VALUE) {
                                return colorConfig.heatmap.empty;
                            }
                            const performance = parseFloat(value);
                            if (performance > 1.5) return colorConfig.heatmap.strongPositive;
                            if (performance > 0) return colorConfig.heatmap.lightPositive;
                            if (performance < -1.5) return colorConfig.heatmap.strongNegative;
                            if (performance < 0) return colorConfig.heatmap.lightNegative;
                            return colorConfig.heatmap.neutral;
                        },
                        borderWidth: 1,
                        borderColor: colorConfig.heatmap.border
                    },
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            };
        }
        function generateHeatmap(sectorData) {
            const dom = document.getElementById('heatmap-chart');
            if (!heatmapChart) {
                heatmapChart = echarts.init(dom, null, { renderer: 'canvas' });
                window.addEventListener('resize', () => {
                    if (heatmapChart && !heatmapChart.isDisposed()) {
                        renderHeatmapLabels();
                        const checkboxContainer = document.getElementById('filter-checkboxes');
                        const selectedSectors = Array.from(checkboxContainer.querySelectorAll('input[type="checkbox"]:checked'))
                                                     .map(cb => cb.value);
                        const currentFilteredData = marketData.sectors.filter(sector => selectedSectors.includes(sector.sector));
                        heatmapChart.setOption(getHeatmapOption(currentFilteredData), true);
                        heatmapChart.resize();
                    }
                });
            }
            heatmapChart.setOption(getHeatmapOption(sectorData), true);
        }
        function exportToCsv(filename) {
            const { sectors, weeks, data } = heatmapDataForExport;
            if (!sectors || !weeks || !data) return;
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Sector," + weeks.map(w => `Week ${w}`).join(",") + "\r\n";
            const dataMatrix = sectors.map(() => Array(weeks.length).fill(''));
            data.forEach(([weekIndex, sectorIndex, value]) => {
                if (value !== -999) {
                    dataMatrix[sectorIndex][weekIndex] = `${value.toFixed(2)}%`;
                }
            });
            sectors.forEach((sector, i) => {
                const row = [sector, ...dataMatrix[i]];
                csvContent += row.join(",") + "\r\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        document.addEventListener('DOMContentLoaded', () => {
            generatePage();
            document.getElementById('exportCsvBtn').addEventListener('click', () => {
                exportToCsv('historical_sector_performance.csv');
            });
            const copyrightP = document.querySelector('footer p.text-xs');
            if (copyrightP) {
                 copyrightP.innerHTML = `&copy; ${new Date().getFullYear()} KaChing Labs. All Rights Reserved. <span class="mx-2 text-gray-600">|</span> <a href="https://kaching-labs.com/legal.html" class="hover:text-emerald-400 underline">Legal Information</a>`;
            }
        });
    </script>
</body>
</html>
